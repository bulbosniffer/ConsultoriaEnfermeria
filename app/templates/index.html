{% extends "base.html" %}

{% block title %}Lista de Usuarios{% endblock %}

{% block encabezado %}Gestión de Usuarios{% endblock %}

{% block contenido %}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Formatos IMSS Bienestar</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Estilo para impresión -->
    <style>
    @media print {
        body * {
            visibility: hidden;
        }
        table, table * {
            visibility: visible;
        }
        table {
            position: absolute;
            top: 0;
            left: 0;
        }
        form, .btn, nav, header, footer {
            display: none !important;
        }
    }
    </style>
</head>
<body class="container mt-4">
    <h1 class="text-success">Formatos IMSS Bienestar</h1>

    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="alert alert-info">{{ messages[0] }}</div>
      {% endif %}
    {% endwith %}

    <!-- Formulario de carga -->
{% if session.usuario %}
    {% if session.rol == 'admin' %}
        <form action="{{ url_for('formatos.upload') }}" method="post" enctype="multipart/form-data">    
            <div class="mb-3">
                <label>Nombre del Formato:</label>
                <input type="text" name="nombre_formato" class="form-control" required>
            </div>
            <div class="mb-3">
                <label for="area">Área:</label>
                <select name="area" id="area" class="form-control" required>
                    <option value="">-- Selecciona un área --</option>
                    <option value="Consulta Externa">Consulta Externa</option>
                    <option value="Urgencias">Urgencias</option>
                    <option value="Hospitalización">Hospitalización</option>
                    <option value="Trabajo Social">Trabajo Social</option>
                    <option value="Medicina Preventiva">Medicina Preventiva</option>
                    <option value="Enfermería">Enfermería</option>
                    <option value="Archivo Clínico">Archivo Clínico</option>
                    <option value="Farmacia">Farmacia</option>
                    <option value="Epidemiología">Epidemiología</option>
                    <option value="Estomatología">Estomatología</option>
                    <option value="Nutrición">Nutrición</option>
                    <option value="Psicología">Psicología</option>
                    <option value="Rehabilitación">Rehabilitación</option>
                    <option value="Rayos X">Rayos X</option>
                    <option value="Laboratorio">Laboratorio</option>
                    <option value="Mantenimiento">Mantenimiento</option>
                    <option value="Administración">Administración</option>
                </select>  
            </div>
            <div class="input-group mb-2">
                <input type="file" name="file" class="form-control" required>
                <button type="submit" class="btn btn-success">Subir</button>
            </div>
            <a href="/logout" class="btn btn-outline-danger btn-sm">Cerrar sesión</a>
        </form>
    {% else %}
        <a href="/login" class="btn btn-primary mb-3">Iniciar sesión para subir archivos</a>
    {% endif %}
{% else %}
    <a href="/login" class="btn btn-primary mb-3">Iniciar sesión para subir archivos</a>
{% endif %}


    <!-- Buscador -->
    <form method="GET" class="row g-3 align-items-center mb-4">
        <div class="col-auto">
            <input type="text" name="filtro_formato" value="{{ filtro_formato }}" placeholder="Buscar por formato" class="form-control">
        </div>
        <div class="col-auto">
            <input type="text" name="filtro_area" value="{{ filtro_area }}" placeholder="Buscar por área" class="form-control">
        </div>
        <div class="col-auto">
            <button type="submit" class="btn btn-primary">Buscar</button>
            <a href="/" class="btn btn-secondary">Limpiar</a>
            <button type="button" class="btn btn-outline-dark" onclick="window.print()">Imprimir tabla</button>
            <a href="{{ url_for('formulario.formulario') }}" class="btn btn-primary">Ir al Consulta Enfermería</a>

	    
        </div>
    </form>

    <!-- Tabla de archivos -->
    <table class="table table-bordered table-striped">
        <thead class="table-success">
            <tr>
                <th>Formato</th>
                <th>Área</th>
                <th>Archivo</th>
                <th>Fecha</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for a in archivos %}
            <tr>
                <td>{{ a['nombre_formato'] }}</td>
                <td>{{ a['area'] }}</td>
                <td>{{ a['filename'] }}</td>
                <td>{{ a['fecha_subida'] }}</td>
                <td>
                    {% if a['filename'].endswith('.pdf') %}
                        <a href="{{ url_for('static', filename='uploads/' + a['filename']) }}" target="_blank" class="btn btn-outline-primary btn-sm">Ver / Imprimir</a>
                    {% endif %}
                    <a href="/download/{{ a['filename'] }}" class="btn btn-success btn-sm">Descargar</a>
                    {% if logged_in %}
                        <form action="{{ url_for('delete_file_post', id=a['id']) }}" method="post" style="display:inline;">
                            <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('¿Eliminar este archivo?');">
                                 Eliminar
                             </button>
</form>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
{% endblock %}
</body>
</html>
